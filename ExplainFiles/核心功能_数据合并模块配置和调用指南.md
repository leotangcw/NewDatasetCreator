# 核心功能_数据合并模块配置和调用指南

> **版本**: v2.0  
> **模块**: `src/data_merger.py`（数据合并核心模块）  
> **最后更新**: 2025-11-14  
> **对应设计文档**: `DesignFiles/核心功能_数据合并模块设计文档.md`

## 目录

1. [模块概述](#1-模块概述)
2. [环境与依赖](#2-环境与依赖)
3. [核心数据结构](#3-核心数据结构)
4. [Python 调用方式](#4-python-调用方式)
5. [命令行用法](#5-命令行用法)
6. [输出文件与目录结构](#6-输出文件与目录结构)
7. [常见问题与排查](#7-常见问题与排查)

---

## 1. 模块概述

`src/data_merger.py` 是自动数据蒸馏软件中负责“同结构数据集合并”的模块，主要职责：

- 将多个字段结构相同的数据文件纵向合并为一个文件；
- 支持“新建合并”（merge）和“追加至现有文件”（append）两种模式；
- 在合并过程中可选地进行简单去重；
- 生成合并元数据和说明文件，记录输入输出行数等信息。

模块不会修改原始文件的字段结构，也不负责复杂的数据清洗或字段映射，这些应在前置模块（如字段提取、格式转换）中完成。

---

## 2. 环境与依赖

### 2.1 依赖安装

在项目根目录执行：

```bash
pip install -r requirements.txt
```

数据合并模块依赖 `pandas`、`jsonlines` 等库，已收录在 `requirements.txt` 中，无需单独安装。

### 2.2 配置与目录

模块通过 `ConfigManager` 获取数据根目录、日志目录和默认编码等配置。典型数据目录结构（与其他模块共用）：

```text
data/
  raw/          # 原始数据
  processed/    # 处理后数据（包含合并结果）
  temp/         # 临时文件
  logs/         # 日志
```

具体合并结果和元数据的子目录及命名规则以设计文档和 `data_merger.py` 源码为准。

---

## 3. 核心数据结构

### 3.1 `MergeTaskParams`

`MergeTaskParams` 是用于描述单次合并任务的参数类型（在源码中通过 `TypedDict` 定义）。常见字段包括：

- `task_id: str`：任务 ID；
- `input_paths: List[str]`：输入文件路径列表；
- `merge_mode: str`：合并模式，通常为 `"merge"` 或 `"append"`；
- `target_path: str`：目标输出文件路径；
- `deduplicate: bool`：是否启用去重；
- `dedup_field: Optional[str]`：去重字段名（可选）；
- `dedup_strategy: str`：去重策略（当前实现实际应用的是“保留首次出现”语义，详见设计文档中对实现局限的说明）；
- `chunk_size: int`：分片大小；
- `encoding: str`：编码。

具体字段和默认值请以源码中的 `MergeTaskParams` 定义为准。

### 3.2 `MergeMeta`

`MergeMeta` 描述一次合并任务的结果元数据，在执行完成后写入 JSON 文件（如 `merge_meta.json`）。常见字段包括：

- 输入文件列表及各自的行数；
- 输出文件路径、总输入/输出行数；
- 去重相关统计；
- 开始/结束时间等。

字段结构以源码中的 `MergeMeta` 类型定义为准。

---

## 4. Python 调用方式

### 4.1 使用 `DataMerger` 类

```python
from src.data_merger import DataMerger, MergeTaskParams

merger = DataMerger()
ok = merger.init_merger()
if not ok:
    raise RuntimeError("DataMerger 初始化失败")

params: MergeTaskParams = {
    "task_id": "merge_20251114_001",
    "input_paths": [
        "./data/processed/part1.jsonl",
        "./data/processed/part2.jsonl",
    ],
    "merge_mode": "merge",
    "target_path": "./data/processed/merged.jsonl",
    "deduplicate": False,
    "dedup_field": None,
    "dedup_strategy": "keep_first",
    "chunk_size": 1000,
    "encoding": "utf-8",
}

# 可选：先做校验
check = merger.validate_merge(params)
if not check.get("valid", False):
    print("校验失败:", check.get("reason"))
else:
    result_path = merger.merge_datasets(params)
    print("合并结果文件:", result_path)
```

> 注意：当前实现中，所谓 `dedup_strategy="keep_last"` 并未严格实现“保留最后一条”的语义，实际行为请以设计文档中的说明和源码实现为准。如需强语义控制，建议在上层增加额外处理。

### 4.2 使用高层封装 `merge_data`

模块还提供了一个更高层的函数（如 `merge_data(...)`），用于简化常见场景：

```python
from src.data_merger import merge_data

result_path = merge_data(
    input_paths=["./data/processed/part1.jsonl", "./data/processed/part2.jsonl"],
    merge_mode="merge",
    deduplicate=True,
    dedup_field="question",
)

print("合并结果文件:", result_path)
```

`merge_data` 会在内部构造 `MergeTaskParams`、选择合适的输出目录和文件名，并调用 `DataMerger` 完成合并。具体参数和行为以源码中的函数签名为准。

---

## 5. 命令行用法

数据合并模块提供命令行入口，可直接从终端合并数据文件。参数解析逻辑在 `main()` 中定义，这里给出典型模式：

```bash
python -m src.data_merger \
  --task_id merge_001 \
  --input_paths data1.jsonl,data2.jsonl \
  --merge_mode merge \
  --target_path merged.jsonl
```

常见参数（名称以当前源码为准）：

- `--task_id`：任务 ID；
- `--input_paths`：以逗号分隔的输入文件路径列表；
- `--merge_mode`：`merge` 或 `append`；
- `--target_path`：目标文件路径；
- `--deduplicate`：是否开启去重（通常为布尔开关或字符串标志）；
- `--dedup_field`：去重字段名（可选）；
- `--dedup_strategy`：去重策略（如 `keep_first`）；
- `--chunk_size`、`--encoding` 等其他参数。

部分实现还支持 `--validate_only` 选项，仅做校验不实际写入输出文件，具体以源码为准。

---

## 6. 输出文件与目录结构

执行合并后，模块通常会生成以下文件：

1. **合并结果文件**：
   - 路径由 `target_path` 或 `merge_data` 的内部规则决定；
   - 格式与输入文件一致（如 JSONL/CSV/JSON/Excel 等）。

2. **合并元数据文件**（例如 `merge_meta.json`）：
   - 包含任务 ID、输入文件列表及行数、输出行数、去重统计、开始结束时间等信息；
   - 具体字段结构由 `MergeMeta` 类型定义。

3. **合并说明文件**（例如 `合并信息.txt`）：
   - 以人类可读的方式简要描述合并结果和关键统计；
   - 由 `data_merger.py` 内部的说明文件生成函数创建。

文件具体位置和命名规则，请参考设计文档“输出文件结构”章节以及源码中的路径拼接逻辑。

---

## 7. 常见问题与排查

本节仅基于当前实现的真实行为，给出典型问题的排查方向。

### 7.1 校验失败

- **格式不一致**：
  - `validate_merge` 会检查所有输入文件的格式是否一致；
  - 如格式不一致，请先使用格式转换模块统一格式。

- **字段不一致**：
  - 校验会比较各文件的字段集合，若不一致则返回失败；
  - 可先通过字段提取模块统一字段，再进行合并。

### 7.2 去重行为不符合预期

- 当前实现仅支持较为简单的去重逻辑：
  - 基于单字段或全行内容进行重复检测；
  - “保留第一条”的语义是可靠的，而“保留最后一条”在现有实现中存在局限（具体见设计文档“去重策略局限”说明）。
- 如需严格的去重策略控制，建议：
  - 在合并前对输入文件先做单独的去重预处理；
  - 或在合并后再通过独立脚本做一次精确去重。

### 7.3 性能与资源

- 对于大文件：
  - 适当增大或减小 `chunk_size`，在 I/O 和内存之间折中；
  - 确保输出目录磁盘空间充足；
  - 监控日志中记录的处理进度和耗时。

### 7.4 日志与调试

- 合并过程中会通过项目统一的日志模块记录关键事件；
- 出现异常或结果异常时，首先查看对应的日志文件以及 `merge_meta.json` 中的统计信息，以定位问题所在。

---

> 本文档严格基于当前 `src/data_merger.py` 源码和 `DesignFiles/核心功能_数据合并模块设计文档.md`，仅描述实际存在的类型、参数和行为，不再包含自定义错误码体系、外部测试脚本或 UI/服务端集成示例。上层系统如需提供 HTTP API、前端页面或批量调度能力，应在本模块之上自行封装。 
