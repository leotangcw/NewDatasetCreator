# 核心功能_格式转换模块配置和调用指南

> **版本**: 0.2 beta  
**作者**: leotcw&AI
> **模块**: `src/format_converter.py`（格式转换核心模块）  
> **最后更新**: 2025-11-14  
> **对应设计文档**: `DesignFiles/核心功能_格式转化模块设计文档.md`

## 目录

1. [模块概述](#1-模块概述)
2. [环境与依赖](#2-环境与依赖)
3. [核心 Python 接口](#3-核心-python-接口)
4. [命令行用法](#4-命令行用法)
5. [任务与元数据](#5-任务与元数据)
6. [常见问题与排查](#6-常见问题与排查)

---

## 1. 模块概述

### 1.1 功能定位

`src/format_converter.py` 是自动数据蒸馏软件的核心格式转换模块，负责在本地文件之间进行格式转换，并与配置、日志和任务/状态管理模块协作。主要能力如下：

- 支持多种表格/文本格式之间的转换（以源码中实际实现为准，通常包括 CSV/JSON/JSONL/Excel/Arrow 等）；
- 通过 `FormatConverter` 类和一组模块级函数管理转换任务；
- 支持大文件按行分片处理，避免一次性读入内存；
- 记录任务状态和元数据，便于排查问题和后续处理。

> 说明：本模块不负责数据清洗、字段提取或数据合并，也不内置 Web/队列封装；这些能力由其它模块（如 `data_cleaner.py`、`field_extractor.py`、`data_merger.py`）或上层服务自行实现。

---

## 2. 环境与依赖

### 2.1 安装依赖

在项目根目录执行：

```bash
pip install -r requirements.txt
```

格式转换模块依赖 `pandas`、`jsonlines`、`pyarrow` 等库，这些都已在 `requirements.txt` 中统一维护。

### 2.2 目录结构

模块依赖配置管理组件提供的数据根目录（通常为 `./data`），其下常见结构如下（仅列与本模块相关部分）：

```text
data/
    raw/          # 原始数据（由数据获取模块写入）
    processed/    # 转换后的标准化数据
    temp/         # 临时文件
    logs/         # 日志文件
```

具体的任务子目录和文件命名以源码实现和设计文档中的描述为准。

### 2.3 配置说明

格式转换模块主要通过 `ConfigManager` 读取全局配置（如根目录、日志目录、默认编码和分片大小等），具体键位以当前 `config.yaml` 和 `ConfigManager` 源码为准。大多数与转换相关的细节（如 `chunk_size`、编码、目标格式等）也可以直接通过函数参数进行覆盖。

---

## 3. 核心 Python 接口

模块统一通过 `FormatConverter` 管理任务，同时提供一组模块级便捷函数。以下接口以当前源码设计为基础，仅说明真实存在的方法和典型用法。

### 3.1 获取全局转换器实例

```python
from src.format_converter import get_converter

converter = get_converter()  # 返回全局单例 FormatConverter
```

### 3.2 创建转换任务

`FormatConverter.add_convert_task(...)` 用于创建一个转换任务。实际参数列表较长，这里仅列出常见参数类别：

- 基础参数：`source_path`（源文件/目录）、`target_format`（目标格式，如 `"csv"`、`"jsonl"` 等）、`output_dir`（可选，覆盖默认输出目录）、`chunk_size`（分片行数）、`encoding`/`output_encoding` 等；
- 格式相关参数：如 `csv_delimiter`、`excel_sheet`、Arrow 数据集的 split 等；
- 数据处理参数：如是否跳过空行或错误行等。

示例：

```python
from src.format_converter import get_converter

converter = get_converter()

task_id = converter.add_convert_task(
    source_path="./data/raw/users.csv",
    target_format="jsonl",
    output_dir="./data/processed",
    chunk_size=1000,
)
```

### 3.3 启动任务并监控进度

```python
converter.start_task(task_id)

while True:
    info = converter.get_task_progress(task_id)
    print("status:", info.get("status"), "progress:", info.get("progress"))
    if info.get("status") in {"completed", "failed"}:
        break
```

`get_task_progress` 的返回字段以源码实现为准，通常至少包含：

- `status`：任务状态（如 `pending`/`running`/`completed`/`failed`）；
- `progress`：完成比例或百分比；
- `error_msg`：错误信息（仅在失败时存在）。

### 3.4 模块级便捷函数

模块通常会提供若干便捷函数（例如 `convert_format` / `start_convert` / `get_convert_progress` / `list_converts` 等），内部基于全局 `FormatConverter` 实例实现。实际函数签名以当前源码为准，典型调用模式如下：

```python
from src import format_converter

task_id = format_converter.convert_format(
    source_path="./data/raw/data.csv",
    target_format="jsonl",
)

format_converter.start_convert(task_id)
info = format_converter.get_convert_progress(task_id)
print(info)
```

> 由于不同版本实现可能对返回值结构和字段命名有调整，使用时请参考源码中的 docstring 和类型定义，以当前版本为准。

---

## 4. 命令行用法

模块提供 `main()` 入口，可直接通过命令行执行单次转换。具体参数和选项以源码中的 `argparse` 定义为准，这里给出典型模式：

```bash
python -m src.format_converter --source ./data/raw/data.csv --target jsonl
```

常见参数（命名以源码为准）：

- `--source`：源文件或目录路径；
- `--target`：目标格式（如 `csv`/`json`/`jsonl`/`excel` 等）；
- `--output-dir`：输出目录（可选）；
- 与格式相关的附加参数（如 Excel 工作表名、Arrow split 等）。

命令行内部同样通过 `FormatConverter` 创建并执行任务，其行为与 Python 调用一致。

---

## 5. 任务与元数据

### 5.1 任务管理

`FormatConverter` 会维护一份任务字典，记录每个任务的参数、状态和进度信息：

- 调用 `add_convert_task` 时创建任务并返回 `task_id`；
- 调用 `start_task(task_id)` 实际执行转换；
- 调用 `get_task_progress(task_id)` 查询状态。

部分实现还可能提供列出任务的辅助方法（如 `list_tasks`），具体以当前源码为准。

### 5.2 元数据文件

转换过程中，模块会在输出目录写入元数据文件（如 `meta.json`），内容通常包括：

- 源/目标路径和格式；
- 开始/结束时间；
- 使用的关键参数；
- 任务最终状态；
- 行数统计等质量信息（如当前实现已包含）。

元数据结构在源码中通过 `TypedDict`（如 `ConvertMeta`）明确约束，实际字段以该定义为准。

---

## 6. 常见问题与排查

本节仅给出与当前模块真实行为直接相关的排查建议。

### 6.1 格式/编码问题

- 如果遇到“无法识别源格式”相关错误，优先检查：
  - 源文件扩展名是否与内容匹配（如 JSON 文件误命名为 `.txt`）；
  - 源路径是否正确存在；
  - 对于 Arrow 数据集，目录结构是否完整。
- 如果出现编码相关异常：
  - 尝试在任务参数中显式指定 `encoding`；
  - 或在上层代码中先探测编码，再将结果传入。

### 6.2 性能与内存

- 对于大文件，建议：
  - 合理设置 `chunk_size`，避免一次性加载全部数据；
  - 优先转换为流式友好的格式（如 JSONL），再进行后续处理；
  - 必要时拆分源文件后分别转换。

### 6.3 日志与调试

- 可以通过全局日志配置提升 `format_converter` 对应 logger 的级别，获取更详细的内部处理日志；
- 结合 `meta.json` 中的统计信息，排查行数不一致、跳过行等问题原因。

---

> 本文档严格基于当前 `src/format_converter.py` 源码和 `DesignFiles/核心功能_格式转化模块设计文档.md`，仅描述实际存在的 API、参数和行为，不再包含尚未实现的错误码体系、前端集成或性能基准等内容。
