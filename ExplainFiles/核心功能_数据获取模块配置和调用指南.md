# 核心功能_数据获取模块配置和调用指南

> **版本**: 0.2 beta  
**作者**: leotcw&AI
> **模块**: `src/dataset_downloader.py`（数据获取核心模块）  
> **最后更新**: 2025-11-14  
> **对应设计文档**: `DesignFiles/核心功能_数据获取模块设计.md`

## 目录

1. [模块概述](#1-模块概述)
2. [环境与依赖](#2-环境与依赖)
3. [数据源与 Token 配置](#3-数据源与-token-配置)
4. [Python 调用方式](#4-python-调用方式)
5. [下载结果与目录结构](#5-下载结果与目录结构)
6. [常见问题和排查建议](#6-常见问题和排查建议)

---

## 1. 模块概述

### 1.1 功能定位

`src/dataset_downloader.py` 是自动数据蒸馏软件的核心数据获取模块，负责从多个数据源下载数据集，并与系统的配置、日志和状态管理模块集成。它提供：

- **多数据源**：Hugging Face、ModelScope、通用 HTTP/HTTPS URL；
- **多认证方式**：任务参数及环境变量中的 token；
- **断点续传**：URL 场景下支持基于 Range 头和临时文件的断点续传；
- **任务管理**：支持创建任务、启动任务以及在进程内查询任务状态。

> 说明：模块本身不内置 Web 接口、任务队列或前端集成封装，如需在 Flask/Vue/Celery 等环境中使用，需要调用方自行封装，在上层按需设计 API。

---

## 2. 环境与依赖

### 2.1 依赖安装

安装项目根目录下的依赖：

```bash
pip install -r requirements.txt
```

数据获取模块本身依赖 `requests`、`tqdm`、Hugging Face / ModelScope 官方库等，均已在 `requirements.txt` 中声明，一般不需要单独安装。

### 2.2 目录结构

模块会根据配置自动创建基础目录结构，默认 `base.root_dir` 为 `./data`：

```text
data/
    raw/           # 原始数据（本模块主要输出目录）
    processed/     # 下游模块使用
    temp/          # 临时文件
    logs/          # 日志
```

实际 `raw` 目录下的层次由不同源类型具体实现决定，详见设计文档中的“数据存储设计”。

配置使用根目录下的 `config.yaml`，其中 `base.root_dir`、日志目录等由 `ConfigManager` 统一管理；数据获取模块不会单独读取其它配置键位，超时、重试等运行参数通过函数参数传入。

---

## 3. 数据源与 Token 配置

### 3.1 支持的数据源

`DatasetDownloader` 支持三类数据源，通过 `source_type` 参数区分：

- `huggingface`：Hugging Face Hub 数据集；
- `modelscope`：ModelScope 社区数据集；
- `url`：任意 HTTP/HTTPS 直链。

### 3.2 Token 优先级

模块内部 token 解析逻辑通过 `_get_huggingface_token` / `_get_modelscope_token` 实现，大致优先级如下（具体以源码为准）：

**Hugging Face token 查找顺序**：

1. 任务参数中的 `token` / `hf_token` / `huggingface_token`；
2. 环境变量 `HUGGINGFACE_HUB_TOKEN` 或 `HF_TOKEN`。

**ModelScope token 查找顺序**：

1. 任务参数中的 `token` / `ms_token` / `modelscope_token`；
2. 环境变量 `MODELSCOPE_API_TOKEN` 或其他兼容变量。

> 建议：生产环境优先使用环境变量存放 token，避免写入代码仓库；本模块不会自动写入或持久化任何 token。

### 3.3 Token 获取方式

#### 3.2.1 Hugging Face Token

1. 访问 [Hugging Face Settings](https://huggingface.co/settings/tokens)
### 3.3 Token 安全建议

- 生产环境：使用环境变量传入 token，避免写入代码仓库；
- 开发环境：可以通过本地环境变量或测试配置文件传入，但不要提交包含真实 token 的文件。

---

## 4. Python 调用方式

模块提供 `DatasetDownloader` 类和若干内部辅助组件（`ConfigManager`、`Logger`、`ProgressTracker` 等）。典型使用方式如下。

### 4.1 创建下载任务

```python
from src.dataset_downloader import DatasetDownloader

downloader = DatasetDownloader()

task_id = downloader.add_download_task(
    source_type='huggingface',      # 'huggingface' / 'modelscope' / 'url'
    dataset_name='squad',           # 数据集名称或 URL
    save_dir=None,                  # 可选，覆盖默认保存目录
    token=None,                     # 可选，认证 token
    resume=True,                    # URL 场景是否尝试断点续传
    timeout=300,                    # 请求超时时间（秒）
    retry_count=3,                  # 重试次数
    headers=None,                   # URL 场景自定义 HTTP 头
    # 其余参数将被收集到 extra_params，例如：
    split='train',                  # HF/MS 数据集的 split
    subset_name=None,               # 子数据集名称（如需要）
)
```

> 说明：`add_download_task` 的精确参数列表以源码为准，这里展示的是常见参数形态。多余的命名参数会统一进入任务配置的 `extra_params` 字段，在具体下载函数中使用。

### 4.2 启动任务与查询进度

```python
# 同步模式：当前进程内直接执行下载
downloader.start_task(task_id, async_mode=False)

# 访问任务信息（ProgressTracker 提供的信息）
task_info = downloader.tasks[task_id]['tracker'].get_info()
print(task_info['status'])    # e.g. 'pending' / 'running' / 'completed' / 'failed'
print(task_info['progress'])  # 0.0 ~ 1.0
print(task_info.get('error_msg'))
```

当前实现中，任务调度与并发控制都是在调用方自行管理的：

- `DatasetDownloader` 会维护一个简单的 `tasks` 字典；
- 不包含复杂的队列/持久化调度中心；
- 如需跨进程或多节点管理，需要调用方在外层自行实现队列和状态持久化。

### 4.3 按数据源类型的注意事项

**Hugging Face（`source_type='huggingface'`）**

- 内部使用 `datasets` / `huggingface_hub` 等官方库拉取数据集；
- 推荐通过 `split`、`data_files` 等参数在 `extra_params` 中控制下载范围；
- 对大数据集，下载时间较长，建议关注磁盘空间和网络质量。

**ModelScope（`source_type='modelscope'`）**

- 内部封装了多种下载路径（SDK/HTTP 等），具体以源码实现为准；
- 对私有数据集必须提供有效 token；
- 若下载目录结构与预期不一致，可参考设计文档中的“文件名修正与校验”说明。

**URL（`source_type='url'`）**

- 支持通过 HTTP Range 实现简单断点续传；
- 参数 `headers` 可用于设置 user-agent 等 HTTP 头；
- 若服务器不支持 Range，则断点续传能力会受限。

---

## 5. 下载结果与目录结构

### 5.1 输出目录

下载结果默认存放在配置中的 `raw` 目录下，实际路径由：

1. `base.root_dir`（如 `./data`）；
2. `raw` 子目录；
3. 数据源类型、数据集名称等规则

共同决定。具体规则可参考设计文档中的“路径规则”和源码中的路径拼接逻辑。

如果在 `add_download_task` 时显式传入 `save_dir`，则会优先使用调用方提供的路径。

### 5.2 任务元数据

`DatasetDownloader` 会结合 `ProgressTracker` 和内部逻辑记录一些元信息，例如：

- 任务状态：`status`（pending / running / completed / failed）；
- 进度：`progress`（0.0~1.0）；
- 错误信息：`error_msg`（如有）；
- 已下载字节数等。 

具体字段可通过 `tracker.get_info()` 返回的字典查看，字段以实际源码为准。

### 5.3 与后续模块的衔接

本模块只负责“把远程数据下载到本地”。后续格式转换、字段提取、合并等操作由 `format_converter.py`、`field_extractor.py`、`data_merger.py` 等模块完成：

1. 使用数据获取模块下载到 `raw` 目录；
2. 使用格式转换模块将原始文件转换为标准格式（如 JSONL）；
3. 使用字段提取模块抽取所需字段；
4. 使用数据合并模块做多源合并与去重。

---

## 6. 常见问题和排查建议

本节只基于当前模块真实行为给出排查思路，不引用源码中不存在的辅助函数。

### 6.1 常见问题类型

- **认证失败**：HF/ModelScope token 不正确或权限不足；
- **网络异常**：连接超时、DNS 问题或被代理/防火墙拦截；
- **数据集不存在**：数据集名称拼写错误或访问私有数据集但无权限；
- **磁盘空间不足**：本地剩余空间不足以存放下载数据；
- **服务端不支持断点续传**：URL 源在中途中断后不能继续，需重新下载。

### 6.2 排查建议

1. **确认 token 来源**：
   - 打印或检查当前进程中的相关环境变量是否正确设置；
   - 确认传入的 `token` 参数是否为最新、且具备读取权限。

2. **检查网络连通性**：
   - 在同一环境下使用 `curl` 或 `requests.get` 测试能否访问目标站点；
   - 如在公司/服务器环境，确认代理和防火墙策略是否允许外网访问。

3. **检查磁盘空间**：
   - 对于大型数据集，提前确认目标磁盘空间是否足够；
   - 定期清理 `temp` 目录中的临时文件和无用缓存。

4. **查看日志与任务信息**：
   - 通过项目的日志模块查看错误堆栈和下载进度；
   - 使用 `tracker.get_info()` 查看任务状态和错误消息。

> 如果需要更完善的错误码体系、Web API、任务队列等能力，建议在当前模块之上单独构建一层“服务封装”，在该层统一定义错误码、REST 接口和前端协议，而不是在 `dataset_downloader.py` 内部直接实现。

---

> 本文档严格基于当前 `src/dataset_downloader.py` 源码和 `DesignFiles/核心功能_数据获取模块设计.md`，仅描述实际存在的配置项和调用方式，不包含任何尚未实现的功能或 API。
        hf_token=token_manager.get_token('huggingface'),
        ms_token=token_manager.get_token('modelscope')
    )
    
    return jsonify(result)
```

---

## 附录

### A. 支持的数据源

| 数据源 | source参数值 | Token获取地址 | 说明 |
|--------|-------------|---------------|------|
| Hugging Face | `huggingface` | [获取Token](https://huggingface.co/settings/tokens) | 最大的开源模型和数据集平台 |
| ModelScope | `modelscope` | [获取Token](https://www.modelscope.cn/my/myaccesstoken) | 阿里云模型社区 |
| 通用URL | `url` | 无需Token | 支持HTTP/HTTPS直链下载 |

### B. 支持的文件格式

| 格式 | 扩展名 | 说明 | 推荐场景 |
|------|--------|------|----------|
| JSONL | `.jsonl` | JSON Lines格式 | 通用，兼容性最好 |
| CSV | `.csv` | 逗号分隔值 | 表格数据，Excel兼容 |
| Parquet | `.parquet` | 列式存储格式 | 大数据，高性能 |
| Excel | `.xlsx` | Excel格式 | 办公软件兼容 |
| JSON | `.json` | 标准JSON | 小数据集 |

### C. 环境变量参考

```bash
# Hugging Face
export HUGGINGFACE_HUB_TOKEN="hf_xxx"  # 官方环境变量
export HF_TOKEN="hf_xxx"               # 通用环境变量

# ModelScope  
export MODELSCOPE_API_TOKEN="ms_xxx"   # ModelScope Token

# 代理设置
export HTTP_PROXY="http://proxy:port"
export HTTPS_PROXY="http://proxy:port"

# 缓存设置
export HF_DATASETS_CACHE="./cache/hf"
export MODELSCOPE_CACHE="./cache/ms"
```

### D. 错误代码参考

| 错误代码 | 错误类型 | 说明 | 解决方法 |
|----------|----------|------|----------|
| AUTH_001 | Token无效 | Token格式错误或已过期 | 重新获取Token |
| AUTH_002 | 权限不足 | Token权限不够访问私有数据集 | 检查数据集权限 |
| NET_001 | 网络超时 | 请求超时 | 检查网络，增加超时时间 |
| NET_002 | 连接失败 | 无法连接到服务器 | 检查网络和代理设置 |
| DATA_001 | 数据集不存在 | 指定的数据集不存在 | 检查数据集名称 |
| DATA_002 | 格式不支持 | 不支持的文件格式 | 选择支持的格式 |
| SYS_001 | 磁盘空间不足 | 存储空间不够 | 清理磁盘或更换路径 |
| SYS_002 | 权限错误 | 文件系统权限不足 | 检查目录权限 |

---

> **说明**: 本文档基于src/dataset_downloader.py模块v1.1版本编写，对应DesignFiles/核心功能_数据获取模块设计.md的完整实现。如有问题或建议，请参考代码注释或联系开发团队。
